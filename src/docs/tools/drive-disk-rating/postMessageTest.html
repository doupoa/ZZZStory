<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <title>PostMessage æ¥æ”¶å™¨ - å®‰å…¨é€šä¿¡æµ‹è¯•å·¥å…·</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }

      .container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h2 {
        color: #333;
        text-align: center;
        margin-bottom: 20px;
      }

      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-active {
        background-color: #4caf50;
      }

      .status-inactive {
        background-color: #f44336;
      }

      .bookmarklet {
        display: block;
        margin: 15px 0;
        padding: 12px;
        background-color: #e3f2fd;
        border: 1px solid #bbdefb;
        border-radius: 4px;
        cursor: move;
      }

      .btn {
        background-color: #2196f3;
        color: white;
        padding: 10px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
      }

      .btn:hover {
        background-color: #1976d2;
      }

      .btn-test {
        background-color: #4caf50;
      }

      .btn-test:hover {
        background-color: #388e3c;
      }

      .btn-clear {
        background-color: #f44336;
      }

      .btn-clear:hover {
        background-color: #d32f2f;
      }

      #output {
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 15px;
        margin-top: 15px;
        max-height: 400px;
        overflow-y: auto;
        font-family: monospace;
        white-space: pre-wrap;
        word-break: break-all;
      }

      .log-entry {
        margin-bottom: 10px;
        padding: 8px;
        border-left: 3px solid #2196f3;
        background-color: #f1f8ff;
      }

      .error-log {
        border-left-color: #f44336;
        background-color: #ffebee;
      }

      .warning-log {
        border-left-color: #ff9800;
        background-color: #fff3e0;
      }

      .controls {
        margin: 15px 0;
        text-align: center;
      }

      .config-section {
        margin: 15px 0;
        padding: 15px;
        background-color: #f9f9f9;
        border-radius: 4px;
        border: 1px dashed #ccc;
      }

      .config-row {
        margin: 10px 0;
        display: flex;
        align-items: center;
      }

      label {
        min-width: 120px;
        font-weight: bold;
      }

      input[type="text"] {
        flex: 1;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>
        <span
          id="status-indicator"
          class="status-indicator status-inactive"
        ></span
        >ç­‰å¾…ä»ç›®æ ‡ç½‘ç«™æ¥æ”¶æ¶ˆæ¯...
      </h2>

      <div class="config-section">
        <h3>å®‰å…¨é…ç½®</h3>
        <div class="config-row">
          <label for="allowed-origin">å…è®¸çš„æ¥æº:</label>
          <input
            type="text"
            id="allowed-origin"
            value="act.mihoyo.com"
            placeholder="è¾“å…¥å…è®¸çš„åŸŸå"
          />
        </div>
        <div class="config-row">
          <label for="your-site-origin">æ‚¨çš„ç«™ç‚¹åœ°å€:</label>
          <input
            type="text"
            id="your-site-origin"
            value="https://zzzstory.doupoa.site"
            placeholder="è¾“å…¥æ‚¨çš„ç«™ç‚¹URL"
          />
        </div>
      </div>

      <div class="bookmarklet">
        <strong>ä¹¦ç­¾å·¥å…·:</strong>
        æ‹–åŠ¨ä»¥ä¸‹æŒ‰é’®åˆ°æµè§ˆå™¨ä¹¦ç­¾æ ï¼Œç„¶ååœ¨ç›®æ ‡ç½‘ç«™ä¸Šç‚¹å‡»å®ƒæ¥å‘é€æµ‹è¯•æ¶ˆæ¯
      </div>
      <a
        id="bookmarklet-btn"
        href="#"
        onclick="alert('è¯·ç›´æ¥æ‹–æ‹½æ­¤æŒ‰é’®åˆ°ä¹¦ç­¾æ ï¼Œä¸è¦ç‚¹å‡»ï¼')"
        >ğŸš€ å‘é€æµ‹è¯•æ¶ˆæ¯</a
      >

      <div class="controls">
        <button class="btn btn-test" onclick="openTarget()">
          æ‰“å¼€ç›®æ ‡ç½‘ç«™è¿›è¡Œæµ‹è¯•
        </button>
        <button class="btn btn-test" onclick="sendTestMessage()">
          å‘é€æ¨¡æ‹Ÿæ¶ˆæ¯
        </button>
        <button class="btn btn-clear" onclick="clearOutput()">æ¸…ç©ºè¾“å‡º</button>
        <button class="btn" onclick="toggleLogging()">åˆ‡æ¢è¯¦ç»†æ—¥å¿—</button>
      </div>

      <div id="stats">æ¶ˆæ¯è®¡æ•°: <span id="message-count">0</span></div>

      <pre id="output"></pre>
    </div>

    <script>
      // é…ç½®ç®¡ç†
      const config = {
        allowedOrigins: ["act.mihoyo.com"],
        SiteOrigin: "https://zzzstory.doupoa.site",
        enableDetailedLogging: false,
        messageCount: 0,
      };

      // DOM å…ƒç´ å¼•ç”¨
      const outputElement = document.getElementById("output");
      const statusIndicator = document.getElementById("status-indicator");
      const messageCountElement = document.getElementById("message-count");

      // åˆå§‹åŒ–
      function init() {
        updateBookmarklet();
        setupEventListeners();
        setStatusActive(true);

        logToUI("ç³»ç»Ÿå°±ç»ªï¼Œå¼€å§‹ç›‘å¬ postMessage...", "info");
      }

      // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
      function setupEventListeners() {
        // ç›‘å¬æ¥è‡ªå…¶ä»–çª—å£çš„æ¶ˆæ¯
        window.addEventListener("message", handleMessage);

        // é…ç½®è¾“å…¥æ¡†å˜åŒ–ç›‘å¬
        document
          .getElementById("allowed-origin")
          .addEventListener("change", updateConfig);
        document
          .getElementById("your-site-origin")
          .addEventListener("change", updateConfig);
      }

      // æ›´æ–°é…ç½®
      function updateConfig() {
        const origins = document
          .getElementById("allowed-origin")
          .value.split(",")
          .map((s) => s.trim())
          .filter(Boolean);
        config.allowedOrigins =
          origins.length > 0 ? origins : ["act.mihoyo.com"];
        config.SiteOrigin =
          document.getElementById("your-site-origin").value ||
          "https://zzzstory.doupoa.site";

        logToUI(
          `é…ç½®å·²æ›´æ–° - å…è®¸æ¥æº: ${config.allowedOrigins.join(", ")}`,
          "info",
        );
      }

      // æ¶ˆæ¯å¤„ç†å™¨
      function handleMessage(event) {
        try {
          // è¯¦ç»†çš„æ¥æºéªŒè¯
          if (!validateOrigin(event.origin)) {
            logToUI(`æ¥æºéªŒè¯å¤±è´¥: ${event.origin}`, "warning");
            return;
          }

          // éªŒè¯æ•°æ®å®Œæ•´æ€§
          if (!event.data || typeof event.data !== "object") {
            logToUI("æ¥æ”¶åˆ°æ— æ•ˆçš„æ•°æ®æ ¼å¼", "warning");
            return;
          }
          alert("å·²æ”¶åˆ°æ¶ˆæ¯");
          // è®°å½•æ¶ˆæ¯
          recordMessage(event);

          // è¾“å‡ºåˆ°ç•Œé¢
          const formattedData = formatMessageData(event);
          logToUI(formattedData, "success");

          // æ§åˆ¶å°æ—¥å¿—
          if (config.enableDetailedLogging) {
            console.log("PostMessage Received:", {
              origin: event.origin,
              data: event.data,
              source: event.source,
              ports: event.ports,
            });
          }
        } catch (error) {
          logToUI(`å¤„ç†æ¶ˆæ¯æ—¶å‡ºé”™: ${error.message}`, "error");
          console.error("Error handling message:", error);
        }
      }

      // éªŒè¯æ¥æº
      function validateOrigin(origin) {
        // æ£€æŸ¥æ˜¯å¦åœ¨å…è®¸çš„æ¥æºåˆ—è¡¨ä¸­
        return config.allowedOrigins.some((allowedOrigin) =>
          origin.includes(allowedOrigin),
        );
      }

      // è®°å½•æ¶ˆæ¯
      function recordMessage(event) {
        config.messageCount++;
        messageCountElement.textContent = config.messageCount;

        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šç»Ÿè®¡é€»è¾‘
      }

      // æ ¼å¼åŒ–æ¶ˆæ¯æ•°æ®
      function formatMessageData(event) {
        return `ã€${new Date().toLocaleString()} æ”¶åˆ°æ¶ˆæ¯ã€‘
æ¥æº: ${event.origin}
æ•°æ®: ${JSON.stringify(event.data, null, 2)}
---`;
      }

      // æ—¥å¿—è¾“å‡ºåˆ°UI
      function logToUI(message, level = "info") {
        const logEntry = document.createElement("div");
        logEntry.className = `log-entry ${level}-log`;
        logEntry.textContent = message;

        outputElement.prepend(logEntry);

        // é™åˆ¶è¾“å‡ºé•¿åº¦ï¼Œé¿å…é¡µé¢è¿‡é•¿
        if (outputElement.children.length > 100) {
          outputElement.removeChild(outputElement.lastChild);
        }
      }

      function updateBookmarklet() {
        const btn = document.getElementById("bookmarklet-btn");

        const rawCode = `(()=>{if(window._napRunning)return alert("è„šæœ¬æ­£åœ¨è¿è¡Œä¸­ï¼Œè¯·å‹¿é‡å¤ç‚¹å‡»");window._napRunning=1;let t=(m,y)=>{let d=document.getElementById("nap-toast");d||(d=document.body.appendChild(Object.assign(document.createElement("div"),{id:"nap-toast",style:'position:fixed;top:20px;right:40%;padding:16px 20px;border-radius:12px;z-index:999;font:500 14px -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;box-shadow:0 10px 40px rgba(0,0,0,.2);transition:.3s;border:1px solid rgba(255,255,255,.2);max-width:320px;line-height:1.5'})));d.style.cssText+=({info:"background:#667eea;color:#fff;",error:"background:#ff416c;color:#fff;cursor:pointer;",success:"background:#11998e;color:#fff;"}[y]||"");d.innerHTML=y=="error"?"[ERROR] "+m+'<div style="font-size:12px;opacity:.9;margin-top:4px;">ç‚¹å‡»å…³é—­</div>':y=="success"?"[OK] "+m:"[WAIT] "+m;d.style.opacity=1;d.style.transform="translateY(0)";y=="error"?d.onclick=()=>{d.style.opacity=0;d.style.transform="translateY(-20px)"}:setTimeout(()=>{d.style.opacity=0;d.style.transform="translateY(-20px)"},y=="success"?4e3:1e4)};t("æ­£åœ¨è¿æ¥æœåŠ¡å™¨...");let A="https://act-api-takumi.mihoyo.com/event/nap_cultivate_tool",O="https://zzzstory.doupoa.site",g=(u,o={})=>fetch(u,{credentials:"include",...o}).then(r=>r.json());Promise.all([g("https://api-takumi.mihoyo.com/common/badge/v1/login/info?game_biz=nap_cn&lang=zh-cn").then(r=>r.data?.game_uid),document.cookie.match(/DEVICEFP=(\\w+)/)?.[1]]).then(async([u,f])=>{if(!u||!f)throw Error("æœªç™»å½•æˆ–Cookieæ— æ•ˆï¼Œè¯·å…ˆç™»å½•æ¸¸æˆè´¦å·");t(\`è´¦å· \${u} å·²è¯†åˆ«ï¼Œæ­£åœ¨è·å–è§’è‰²åˆ—è¡¨...\`);let{data:{list:l}}=await g(\`\${A}/user/avatar_basic_list?uid=\${u}&region=prod_gf_cn\`,{headers:{"x-rpc-device_fp":f}}),i=l.filter(x=>x.unlocked).map(x=>({avatar_id:x.avatar.id}));if(!i.length)throw Error("æ²¡æœ‰æ‰¾åˆ°å·²è§£é”çš„è§’è‰²");t(\`æ‰¾åˆ° \${i.length} ä¸ªè§’è‰²ï¼Œåˆ†æ‰¹è·å–è£…å¤‡æ•°æ®...\`);let b=[...Array(Math.ceil(i.length/10))].map((_,k)=>i.slice(k*10,k*10+10)),d=(await Promise.all(b.map(s=>g(\`\${A}/user/batch_avatar_detail_v2?uid=\${u}&region=prod_gf_cn\`,{method:"POST",headers:{"x-rpc-device_fp":f},body:JSON.stringify({avatar_list:s})})))) .flatMap(r=>r.data.list.map(({name:n,equip:e})=>({[n]:(e||[]).map(({main_properties:m,properties:p})=>({main:m?.[0]?{name:m[0].property_name,add:m[0].add}:null,sub:p?.map(x=>({name:x.property_name,add:x.add}))||[]}))})));if(!window.opener)throw Error("æœªæ‰¾åˆ°æ¥æºé¡µé¢ï¼ˆè¯·ä»åˆ†æç«™ç‚¹ç‚¹å‡»ä¹¦ç­¾æ‰“å¼€ï¼‰");window.opener.postMessage({type:"nap-data",payload:d,uid:u,timestamp:Date.now()},O);t(\`æˆåŠŸï¼å·²å‘é€ \${d.length} ä¸ªè§’è‰²çš„è£…å¤‡æ•°æ®ï¼Œè¯·åˆ‡æ¢å›åŸåˆ†æé¡µé¢æŸ¥çœ‹\`,"success");window._napRunning=0}).catch(e=>{t(e.message,"error");console.error(e);window._napRunning=0})})();`;

        // UTF-8 â†’ Base64
        const bytes = new TextEncoder().encode(rawCode);
        let bin = "";
        bytes.forEach((b) => (bin += String.fromCharCode(b)));
        const base64 = btoa(bin);

        // ä¹¦ç­¾æ‰§è¡Œï¼šBase64 â†’ UTF-8 â†’ eval
        btn.href =
          "javascript:(()=>{const b=atob('" +
          base64 +
          "');eval(new TextDecoder().decode(Uint8Array.from(b,c=>c.charCodeAt(0))))})();";
      }

      // æ‰“å¼€ç›®æ ‡ç½‘ç«™
      function openTarget() {
        const targetUrl =
          "https://act.mihoyo.com/zzz/gt/character-builder-h/index.html";
        window.open(targetUrl, "_blank");
        logToUI(`å·²æ‰“å¼€ç›®æ ‡ç½‘ç«™: ${targetUrl}`, "info");
      }

      // å‘é€æ¨¡æ‹Ÿæ¶ˆæ¯ï¼ˆç”¨äºæœ¬åœ°æµ‹è¯•ï¼‰
      function sendTestMessage() {
        const testData = {
          type: "test-message",
          payload: {
            message: "è¿™æ˜¯æµ‹è¯•æ¶ˆæ¯",
            timestamp: Date.now(),
            testId: Math.random().toString(36).substring(7),
          },
        };

        // æ¨¡æ‹Ÿä»å…è®¸çš„æºå‘é€æ¶ˆæ¯
        const mockEvent = {
          origin: "https://act.mihoyo.com",
          data: testData,
          source: window,
          ports: [],
        };

        handleMessage(mockEvent);
        logToUI("å·²å‘é€æ¨¡æ‹Ÿæ¶ˆæ¯", "info");
      }

      // æ¸…ç©ºè¾“å‡º
      function clearOutput() {
        outputElement.innerHTML = "";
        config.messageCount = 0;
        messageCountElement.textContent = "0";
        logToUI("è¾“å‡ºå·²æ¸…ç©º", "info");
      }

      // åˆ‡æ¢è¯¦ç»†æ—¥å¿—
      function toggleLogging() {
        config.enableDetailedLogging = !config.enableDetailedLogging;
        logToUI(
          `è¯¦ç»†æ—¥å¿—: ${config.enableDetailedLogging ? "å¼€å¯" : "å…³é—­"}`,
          "info",
        );
      }

      // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
